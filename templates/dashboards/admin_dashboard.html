{% extends "base.html" %}
{% block content %}

<div class="flex-between">
  <h1 class="h1">Admin Dashboard</h1>
  <div class="nav">
    <a class="btn btn-secondary"
      href="{% url 'dashboards:export_engagement_csv' %}{% if status %}?status={{status}}{% endif %}">
      Export CSV
    </a>
    <a class="btn btn-secondary" href="/django-admin/">
      Django Admin
    </a>
  </div>
</div>

<div class="card" style="margin-bottom: 2rem;">
  <form method="get" class="nav">
    <label class="form-label" style="margin-bottom: 0;">Filter Status:</label>
    <select name="status" class="form-input" style="width: auto; padding: 8px 36px 8px 16px;"
      onchange="this.form.submit()">
      <option value="" {% if not status %}selected{% endif %}>All Students</option>
      <option value="active" {% if status == "active" %}selected{% endif %}>Active</option>
      <option value="at_risk" {% if status == "at_risk" %}selected{% endif %}>At Risk</option>
      <option value="inactive" {% if status == "inactive" %}selected{% endif %}>Inactive</option>
    </select>
  </form>
</div>

<div class="dashboard-grid">
  <div class="stat-card"><b>Total Students</b>
    <div>{{ counts.total }}</div>
  </div>
  <div class="stat-card"><b>Active</b>
    <div>{{ counts.active }}</div>
  </div>
  <div class="stat-card"><b>At Risk</b>
    <div>{{ counts.at_risk }}</div>
  </div>
  <div class="stat-card"><b>Inactive</b>
    <div>{{ counts.inactive }}</div>
  </div>
</div>

<div class="table-container">
  <table>
    <thead>
      <tr>
        <th>UID</th>
        <th>Student Name</th>
        <th>Class</th>
        <th>Parent/Guardian</th>
        <th>Status</th>
        <th>Last Active</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for r in rows %}
      <tr>
        <td>{{ r.student_uid }}</td>
        <td>{{ r.full_name }}</td>
        <td>Class {{ r.class_grade }}</td>
        <td>
          <b>{{ r.parent_name }}</b>
        </td>
        <td>
          <span class="badge badge-{{ r.engagement_status }}-status">
            {{ r.engagement_status|title }}
          </span>
        </td>
        <td>
          {% if r.last_login_at %}
          {{ r.last_login_at|date:"M d, Y" }}
          <div class="hint">{{ r.inactivity_days }} days ago</div>
          {% else %}
          <span class="hint">Never</span>
          {% endif %}
        </td>
        <td>
          <a class="btn-primary" style="padding: 6px 12px; font-size: 12px;"
            href="{% url 'dashboards:mark_active_now' r.id %}">
            Mark Active
          </a>
        </td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="7" style="text-align: center; padding: 3rem;">No students found matching filters.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% endblock %}